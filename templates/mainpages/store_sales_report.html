{% extends 'base_sidebar.html' %}
{% load static %}
{% load analytics_extras %}

{% block title %}Sales Report - {{ store.name }}{% endblock %}
{% block page_title %}Sales Report{% endblock %}

{% block sidebar_menu %}
{% include 'sidebar_navigation.html' %}
{% endblock %}

{% block extra_css %}
<style>
    /* Page Header Styles */
    .page-header {
        margin-bottom: 2rem;
    }

    .page-header h1 {
        color: var(--secondary-dark);
        font-weight: 600;
        margin-bottom: 0.5rem;
    }

    .page-header p {
        color: #6c757d;
        margin-bottom: 0;
    }

    .filter-row {
        display: flex;
        gap: 15px;
        align-items: end;
        flex-wrap: wrap;
    }

    .filter-group {
        flex: 1;
        min-width: 200px;
    }

    .filter-label {
        color: #C5C6C7;
        font-weight: 600;
        margin-bottom: 8px;
        display: block;
    }

    .filter-input {
        width: 100%;
        padding: 12px 15px;
        border: 2px solid rgba(102, 252, 241, 0.3);
        border-radius: 8px;
        background: rgba(255, 255, 255, 0.1);
        color: #C5C6C7;
        font-size: 14px;
        transition: all 0.3s ease;
    }

    .filter-input:focus {
        outline: none;
        border-color: #66FCF1;
        box-shadow: 0 0 15px rgba(102, 252, 241, 0.3);
        background: rgba(255, 255, 255, 0.15);
    }

    .btn-filter {
        background: linear-gradient(135deg, #66FCF1 0%, #45A29E 100%);
        color: #0B0C10;
        border: none;
        padding: 12px 25px;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        text-decoration: none;
        display: inline-block;
    }

    .btn-filter:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(102, 252, 241, 0.4);
        color: #0B0C10;
    }

    .btn-export {
        background: linear-gradient(135deg, #45A29E 0%, #66FCF1 100%);
        color: #0B0C10;
        border: none;
        padding: 10px 20px;
        border-radius: 6px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        text-decoration: none;
        display: inline-block;
        margin-right: 10px;
    }

    .btn-export:hover {
        transform: translateY(-1px);
        box-shadow: 0 3px 10px rgba(69, 162, 158, 0.4);
        color: #0B0C10;
    }

    .summary-cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }

    .summary-card {
        background: rgba(255, 255, 255, 0.05);
        border-radius: 15px;
        padding: 25px;
        border: 1px solid rgba(102, 252, 241, 0.2);
        text-align: center;
        transition: all 0.3s ease;
    }

    .summary-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 30px rgba(102, 252, 241, 0.2);
        border-color: #66FCF1;
    }

    .summary-value {
        font-size: 2.5rem;
        font-weight: 700;
        color: #66FCF1;
        margin-bottom: 10px;
        text-shadow: 0 0 15px rgba(102, 252, 241, 0.3);
    }

    .summary-label {
        color: #C5C6C7;
        font-size: 1rem;
        font-weight: 500;
    }

    .data-table-container {
        background: rgba(255, 255, 255, 0.05);
        border-radius: 15px;
        padding: 25px;
        border: 1px solid rgba(102, 252, 241, 0.2);
        overflow-x: auto;
        margin-bottom: 20px;
    }

    .table-wrapper {
        max-height: 500px;
        overflow-y: auto;
        border-radius: 10px;
        border: 1px solid rgba(102, 252, 241, 0.2);
        background: rgba(255, 255, 255, 0.02);
        position: relative;
    }

    /* Dynamic height based on content */
    .table-wrapper table {
        min-height: auto;
    }

    /* Ensure table doesn't create unnecessary space */
    .table-wrapper:empty {
        display: none;
    }

    .table-wrapper::-webkit-scrollbar {
        width: 8px;
    }

    .table-wrapper::-webkit-scrollbar-track {
        background: rgba(27, 40, 51, 0.5);
        border-radius: 4px;
    }

    .table-wrapper::-webkit-scrollbar-thumb {
        background: linear-gradient(135deg, #45A29E 0%, #66FCF1 100%);
        border-radius: 4px;
    }

    .table-wrapper::-webkit-scrollbar-thumb:hover {
        background: linear-gradient(135deg, #66FCF1 0%, #45A29E 100%);
    }

    /* Responsive table height */
    @media (max-height: 800px) {
        .table-wrapper {
            max-height: 400px;
        }
    }

    @media (max-height: 600px) {
        .table-wrapper {
            max-height: 300px;
        }
    }

    @media (max-width: 768px) {
        .table-wrapper {
            max-height: 350px;
        }
    }

    .pagination-container {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 20px;
        padding: 15px 0;
        border-top: 1px solid rgba(102, 252, 241, 0.2);
        flex-wrap: wrap;
        gap: 15px;
    }

    .pagination-info {
        color: #C5C6C7;
        font-size: 0.9rem;
        min-width: 150px;
    }

    .pagination-controls {
        display: flex;
        gap: 10px;
        align-items: center;
        flex-wrap: wrap;
    }

    .pagination-btn {
        background: linear-gradient(135deg, #45A29E 0%, #66FCF1 100%);
        color: #0B0C10;
        border: none;
        padding: 8px 15px;
        border-radius: 6px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        text-decoration: none;
        display: inline-block;
        font-size: 0.9rem;
        min-width: 40px;
        text-align: center;
    }

    .pagination-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 3px 10px rgba(69, 162, 158, 0.4);
        color: #0B0C10;
        text-decoration: none;
    }

    .pagination-btn:disabled {
        background: rgba(197, 198, 199, 0.3);
        color: rgba(197, 198, 199, 0.6);
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
    }

    .pagination-btn.current {
        background: #66FCF1;
        color: #0B0C10;
        font-weight: bold;
        box-shadow: 0 2px 8px rgba(102, 252, 241, 0.3);
    }

    .page-size-selector {
        display: flex;
        align-items: center;
        gap: 10px;
        color: #C5C6C7;
        font-size: 0.9rem;
    }

    .page-size-select {
        background: rgba(255, 255, 255, 0.1);
        color: #C5C6C7;
        border: 1px solid rgba(102, 252, 241, 0.3);
        border-radius: 6px;
        padding: 5px 10px;
        font-size: 0.9rem;
    }

    @media (max-width: 768px) {
        .pagination-container {
            flex-direction: column;
            align-items: stretch;
            gap: 10px;
        }

        .pagination-controls {
            justify-content: center;
        }

        .pagination-info {
            text-align: center;
            min-width: auto;
        }
    }

    .data-table {
        width: 100%;
        border-collapse: collapse;
        margin: 0;
        min-width: 800px;
        /* Ensure table doesn't get too cramped */
    }

    /* Responsive table adjustments */
    @media (max-width: 1200px) {
        .data-table {
            font-size: 0.9rem;
        }

        .data-table th,
        .data-table td {
            padding: 8px 6px;
        }
    }

    @media (max-width: 992px) {
        .data-table {
            font-size: 0.8rem;
            min-width: 700px;
        }

        .data-table th,
        .data-table td {
            padding: 6px 4px;
        }
    }

    @media (max-width: 768px) {
        .data-table {
            font-size: 0.75rem;
            min-width: 600px;
        }

        .data-table th,
        .data-table td {
            padding: 4px 3px;
        }

        .data-table-container {
            padding: 15px;
        }
    }

    .data-table th {
        background: linear-gradient(135deg, #66FCF1 0%, #45A29E 100%);
        color: #0B0C10;
        padding: 15px 12px;
        text-align: left;
        font-weight: 600;
        border: none;
        position: sticky;
        top: 0;
        z-index: 10;
    }

    .data-table td {
        padding: 12px;
        border-bottom: 1px solid rgba(102, 252, 241, 0.1);
        color: #C5C6C7;
        vertical-align: middle;
    }

    .data-table tr:hover {
        background: rgba(102, 252, 241, 0.05);
    }

    .profit-positive {
        color: #4CAF50;
        font-weight: 600;
    }

    .profit-negative {
        color: #f44336;
        font-weight: 600;
    }

    .export-section {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }

    .export-buttons {
        display: flex;
        gap: 10px;
    }

    .table-info {
        color: #C5C6C7;
        font-size: 0.9rem;
    }

    .no-data {
        text-align: center;
        color: #C5C6C7;
        font-size: 1.2rem;
        padding: 50px;
    }

    .loading {
        text-align: center;
        color: #66FCF1;
        font-size: 1.1rem;
        padding: 30px;
    }

    @media (max-width: 768px) {
        .filter-row {
            flex-direction: column;
        }

        .filter-group {
            min-width: 100%;
        }

        .summary-cards {
            grid-template-columns: 1fr;
        }

        .export-section {
            flex-direction: column;
            gap: 15px;
            align-items: stretch;
        }

        .export-buttons {
            justify-content: center;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Page Header -->
    <div class="page-header">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h1 class="h3 mb-0 text-gray-800">
                    <i class="bi bi-graph-up-arrow text-primary me-2"></i>
                    Sales Report
                </h1>
                <p class="text-muted">{{ store.name }} - Comprehensive Sales Analysis</p>
            </div>
            <div class="d-flex gap-2">
                <button class="btn btn-outline-primary btn-sm" onclick="window.location.reload()">
                    <i class="bi bi-arrow-clockwise me-1"></i>Refresh
                </button>
            </div>
        </div>
    </div>

    <!-- Filters Section -->
    <div class="ezm-card mb-4">
        <div class="ezm-card-header">
            <i class="bi bi-funnel me-2"></i>Filter Options
        </div>
        <div class="card-body">
            <form method="GET" action="{% url 'store_sales_report' %}">
                <div class="row g-3">
                    <div class="col-md-6 col-lg-2">
                        <label class="form-label">Start Date</label>
                        <input type="date" name="start_date" class="form-control" value="{{ start_date|date:'Y-m-d' }}">
                    </div>
                    <div class="col-md-6 col-lg-2">
                        <label class="form-label">End Date</label>
                        <input type="date" name="end_date" class="form-control" value="{{ end_date|date:'Y-m-d' }}">
                    </div>
                    <div class="col-md-6 col-lg-2">
                        <label class="form-label">Category</label>
                        <select name="category" class="form-select">
                            <option value="">All Categories</option>
                            {% for category in categories %}
                            <option value="{{ category }}">{{ category }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-6 col-lg-2">
                        <label class="form-label">Payment Method</label>
                        <select name="payment_method" class="form-select">
                            <option value="">All Methods</option>
                            <option value="cash">Cash</option>
                            <option value="mobile">Mobile Banking</option>
                            <option value="bank">Bank Transfer</option>
                        </select>
                    </div>
                    <div class="col-md-6 col-lg-2 d-flex align-items-end">
                        <button type="submit" class="btn btn-ezm-primary w-100">
                            <i class="bi bi-search me-2"></i>Apply Filters
                        </button>
                    </div>
                </div>
            </form>
        </div>

    </div>

    <!-- Summary Statistics -->
    <div class="row mb-4">
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="ezm-card text-center">
                <div class="card-body">
                    <i class="bi bi-currency-dollar text-success mb-2" style="font-size: 2rem;"></i>
                    <h4 class="text-success mb-1">{{ total_revenue|currency }}</h4>
                    <p class="text-muted mb-0">Total Revenue</p>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="ezm-card text-center">
                <div class="card-body">
                    <i class="bi bi-box text-primary mb-2" style="font-size: 2rem;"></i>
                    <h4 class="text-primary mb-1">{{ total_units_sold|floatformat:0 }}</h4>
                    <p class="text-muted mb-0">Units Sold</p>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="ezm-card text-center">
                <div class="card-body">
                    <i class="bi bi-receipt text-info mb-2" style="font-size: 2rem;"></i>
                    <h4 class="text-info mb-1">{{ total_transactions }}</h4>
                    <p class="text-muted mb-0">Transactions</p>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="ezm-card text-center">
                <div class="card-body">
                    <i class="bi bi-graph-up text-warning mb-2" style="font-size: 2rem;"></i>
                    <h4 class="text-warning mb-1">{{ avg_transaction_value|currency }}</h4>
                    <p class="text-muted mb-0">Avg Transaction</p>
                </div>
            </div>
        </div>
    </div>



    <!-- Top Products Section -->
    {% if top_products %}
    <div class="ezm-card mb-4">
        <div class="ezm-card-header">
            <i class="bi bi-trophy me-2"></i>Top Performing Products
        </div>
        <div class="card-body">
            <div class="row">
                {% for product in top_products|slice:":5" %}
                <div class="col-md-6 col-lg-4 mb-3">
                    <div
                        style="background: rgba(102, 252, 241, 0.1); border-radius: 10px; padding: 15px; border: 1px solid rgba(102, 252, 241, 0.2);">
                        <h6 style="color: #66FCF1; margin-bottom: 10px;">{{ product.name|truncatechars:25 }}</h6>
                        <p style="color: #C5C6C7; margin-bottom: 5px; font-size: 0.9rem;">
                            <strong>Revenue:</strong> {{ product.total_revenue|currency }}
                        </p>
                        <p style="color: #C5C6C7; margin-bottom: 5px; font-size: 0.9rem;">
                            <strong>Units Sold:</strong> {{ product.total_quantity }}
                        </p>
                        <p style="color: #C5C6C7; margin-bottom: 0; font-size: 0.9rem;">
                            <strong>Profit:</strong> {{ product.total_profit|currency }}
                        </p>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Sales Data Table -->
    <div class="ezm-card">
        <div class="ezm-card-header d-flex justify-content-between align-items-center">
            <div>
                <i class="bi bi-table me-2"></i>Sales Data
            </div>
            <div class="d-flex gap-2">
                <a href="?{{ request.GET.urlencode }}&export=pdf" class="btn btn-outline-primary btn-sm">
                    <i class="bi bi-file-earmark-pdf me-1"></i>PDF
                </a>
                <a href="?{{ request.GET.urlencode }}&export=excel" class="btn btn-outline-success btn-sm">
                    <i class="bi bi-file-earmark-excel me-1"></i>Excel
                </a>
            </div>
        </div>
        <div class="card-body p-0">
            <div class="d-flex justify-content-between align-items-center p-3 border-bottom">
                <small class="text-muted">
                    <i class="bi bi-info-circle me-1"></i>
                    {% if page_obj %}
                    Showing {{ page_obj.start_index }}-{{ page_obj.end_index }} of {{ total_sales_count }} sales records
                    {% else %}
                    Showing {{ sales_data|length }} sales records
                    {% endif %}
                </small>
            </div>

            {% if page_obj %}
            <div class="table-responsive" style="max-height: 500px; overflow-y: auto;">
                <table class="table table-hover mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>Date</th>
                            <th>Product</th>
                            <th>SKU</th>
                            <th>Category</th>
                            <th>Supplier</th>
                            <th>Qty</th>
                            <th>Unit Price</th>
                            <th>Total</th>
                            <th>Profit</th>
                            <th>Margin %</th>
                            <th>Stock</th>
                            <th>Payment</th>
                            <th>Receipt</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in page_obj %}
                        <tr>
                            <td>{{ item.sale_date|date:"M d, Y H:i" }}</td>
                            <td>{{ item.product_name|truncatechars:25 }}</td>
                            <td>{{ item.product_sku }}</td>
                            <td>{{ item.category }}</td>
                            <td>{{ item.supplier|truncatechars:20 }}</td>
                            <td>{{ item.quantity_sold }}</td>
                            <td>{{ item.unit_price|currency }}</td>
                            <td>{{ item.line_total|currency }}</td>
                            <td
                                class="{% if item.total_profit >= 0 %}profit-positive{% else %}profit-negative{% endif %}">
                                {{ item.total_profit|currency }}
                            </td>
                            <td
                                class="{% if item.profit_margin >= 0 %}profit-positive{% else %}profit-negative{% endif %}">
                                {{ item.profit_margin|floatformat:1 }}%
                            </td>
                            <td>{{ item.remaining_stock }}</td>
                            <td>{{ item.payment_method|title }}</td>
                            <td>{{ item.receipt_number }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            {% else %}
            <div class="text-center py-5">
                <i class="bi bi-inbox display-1 mb-3 text-muted"></i>
                <h5 class="text-muted">No sales data found</h5>
                <p class="text-muted">No sales data found for the selected criteria. Try adjusting your filters or date
                    range.</p>
            </div>
            {% endif %}
        </div>
    </div>
    {% endblock %}

    {% block extra_js %}
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Initialize charts

            // Auto-submit form when date inputs change
        });

        function initializeSalesTrendChart() {
            const ctx = document.getElementById('salesTrendChart');
            if (!ctx) return;

            // Get pre-processed chart data from server
            try {
                const chartDataRaw = '{{ chart_data|escapejs }}';
                const chartData = JSON.parse(chartDataRaw);
                const salesTrendData = chartData.sales_trend;
                const sortedDates = salesTrendData.labels;
                const salesValues = salesTrendData.data;

                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: sortedDates,
                        datasets: [{
                            label: 'Daily Sales (ETB)',
                            data: salesValues,
                            borderColor: '#66FCF1',
                            backgroundColor: 'rgba(102, 252, 241, 0.1)',
                            tension: 0.4,
                            fill: true,
                            pointBackgroundColor: '#66FCF1',
                            pointBorderColor: '#45A29E',
                            pointHoverBackgroundColor: '#45A29E',
                            pointHoverBorderColor: '#66FCF1'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                labels: {
                                    color: '#C5C6C7'
                                }
                            }
                        },
                        scales: {
                            x: {
                                ticks: {
                                    color: '#C5C6C7'
                                },
                                grid: {
                                    color: 'rgba(197, 198, 199, 0.1)'
                                }
                            },
                            y: {
                                ticks: {
                                    color: '#C5C6C7',
                                    callback: function (value) {
                                        return 'ETB ' + value.toLocaleString();
                                    }
                                },
                                grid: {
                                    color: 'rgba(197, 198, 199, 0.1)'
                                }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Error initializing sales trend chart:', error);
            }
        }

        function initializePaymentMethodChart() {
            const ctx = document.getElementById('paymentMethodChart');
            if (!ctx) return;

            // Get pre-processed payment method data
            try {
                const chartDataRaw = '{{ chart_data|escapejs }}';
                const chartData = JSON.parse(chartDataRaw);
                const paymentMethodData = chartData.payment_methods;
                const labels = paymentMethodData.labels;
                const data = paymentMethodData.data;
                const colors = ['#66FCF1', '#45A29E', '#C5C6C7', '#1F2833'];

                new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: data,
                            backgroundColor: colors,
                            borderColor: '#0B0C10',
                            borderWidth: 2,
                            hoverBorderWidth: 3
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    color: '#C5C6C7',
                                    padding: 20,
                                    usePointStyle: true
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function (context) {
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = ((context.parsed / total) * 100).toFixed(1);
                                        return context.label + ': ETB ' + context.parsed.toLocaleString() + ' (' + percentage + '%)';
                                    }
                                }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Error initializing payment method chart:', error);
            }
        }

        // Function to change page size
        function changePageSize(newSize) {
            const url = new URL(window.location);
            url.searchParams.set('page_size', newSize);
            url.searchParams.set('page', '1'); // Reset to first page
            console.log('changePageSize called with newSize:', newSize);
            window.location.href = url.toString();
        }
    </script>
    {% endblock %}