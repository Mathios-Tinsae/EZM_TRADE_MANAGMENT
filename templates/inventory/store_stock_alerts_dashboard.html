{% extends 'base_sidebar.html' %}
{% load static %}

{% block title %}Stock Alerts - {{ store.name }}{% endblock %}
{% block page_title %}Stock Alerts{% endblock %}

{% block extra_css %}
<style>
  .stats-card {
    background: var(--white);
    border-radius: 12px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    border: none;
    padding: 1.5rem;
    text-align: center;
    transition: all 0.3s ease;
  }

  .stats-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 30px rgba(0, 0, 0, 0.15);
  }

  .stats-number {
    font-size: 2rem;
    font-weight: 700;
    color: var(--accent-teal);
    margin-bottom: 0.5rem;
  }

  .stats-label {
    color: #6c757d;
    font-size: 0.9rem;
    font-weight: 500;
  }

  .ezm-card {
    background: var(--white);
    border-radius: 12px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    border: none;
    margin-bottom: 1.5rem;
  }

  .ezm-card-header {
    background: linear-gradient(90deg, var(--accent-teal), var(--accent-cyan));
    color: var(--white);
    border-radius: 12px 12px 0 0;
    padding: 1rem 1.5rem;
    font-weight: 600;
  }

  .alert-card {
    border-left: 4px solid #ffc107;
    background: rgba(255, 193, 7, 0.1);
  }

  .critical-card {
    border-left: 4px solid #dc3545;
    background: rgba(220, 53, 69, 0.1);
  }

  .out-of-stock-card {
    border-left: 4px solid #6c757d;
    background: rgba(108, 117, 125, 0.1);
  }

  .stock-status-badge {
    font-size: 0.75rem;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-weight: 500;
  }

  .status-critical {
    background: #f8d7da;
    color: #721c24;
  }

  .status-low {
    background: #fff3cd;
    color: #856404;
  }

  .status-out {
    background: #e2e3e5;
    color: #383d41;
  }

  .btn-ezm-primary {
    background: linear-gradient(45deg, var(--accent-teal), var(--accent-cyan));
    border: none;
    color: var(--white);
    padding: 0.5rem 1rem;
    border-radius: 8px;
    font-weight: 500;
    text-decoration: none;
    display: inline-block;
    transition: all 0.3s ease;
  }

  .btn-ezm-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(69, 162, 158, 0.4);
    color: var(--white);
    text-decoration: none;
  }

  .btn-ezm-secondary {
    background: var(--secondary-dark);
    border: none;
    color: var(--white);
    padding: 0.5rem 1rem;
    border-radius: 8px;
    font-weight: 500;
    text-decoration: none;
    display: inline-block;
    transition: all 0.3s ease;
  }

  .btn-ezm-secondary:hover {
    background: var(--primary-dark);
    color: var(--white);
    text-decoration: none;
  }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
  <!-- Header -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h2 class="mb-0">
        <i class="bi bi-exclamation-triangle text-warning me-2"></i>
        Stock Alerts - {{ store.name }}
      </h2>
      <p class="text-muted mb-0">Monitor and manage low stock alerts for your store</p>
    </div>
    <div class="d-flex gap-2">
      <a href="{% url 'stock_list' %}" class="btn btn-ezm-secondary">
        <i class="bi bi-boxes me-1"></i>Full Stock List
      </a>
      <a href="{% url 'store_manager_page' %}" class="btn btn-ezm-primary">
        <i class="bi bi-arrow-left me-1"></i>Back to Dashboard
      </a>
    </div>
  </div>

  <!-- Summary Statistics -->
  <div class="row mb-4">
    <div class="col-md-3">
      <div class="stats-card">
        <div class="stats-number text-warning">{{ total_low_stock }}</div>
        <div class="stats-label">Low Stock Items</div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="stats-card">
        <div class="stats-number text-danger">{{ out_of_stock }}</div>
        <div class="stats-label">Out of Stock</div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="stats-card">
        <div class="stats-number text-danger">{{ critical_stock }}</div>
        <div class="stats-label">Critical Stock (â‰¤5)</div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="stats-card">
        <div class="stats-number">{{ page_obj.paginator.count }}</div>
        <div class="stats-label">Total Alerts</div>
      </div>
    </div>
  </div>

  <!-- Filters -->
  <div class="ezm-card">
    <div class="card-body">
      <form method="get" class="row g-3">
        <div class="col-md-4">
          <label for="search" class="form-label">Search Products</label>
          <input type="text" class="form-control" id="search" name="search" 
                 value="{{ search_query }}" placeholder="Search by product name...">
        </div>
        <div class="col-md-4">
          <label for="category" class="form-label">Category</label>
          <select class="form-select" id="category" name="category">
            <option value="">All Categories</option>
            {% for category in categories %}
            <option value="{{ category }}" {% if category == category_filter %}selected{% endif %}>
              {{ category|title }}
            </option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-4 d-flex align-items-end">
          <button type="submit" class="btn btn-ezm-primary me-2">
            <i class="bi bi-search me-1"></i>Filter
          </button>
          <a href="{% url 'stock_alerts_dashboard' %}" class="btn btn-outline-secondary">
            <i class="bi bi-x-circle me-1"></i>Clear
          </a>
        </div>
      </form>
    </div>
  </div>

  <!-- Low Stock Products -->
  <div class="ezm-card">
    <div class="ezm-card-header">
      <i class="bi bi-list-ul me-2"></i>Low Stock Products
      {% if page_obj.paginator.count > 0 %}
      <span class="badge bg-warning ms-2">{{ page_obj.paginator.count }}</span>
      {% endif %}
    </div>
    <div class="card-body p-0">
      {% if page_obj %}
      <div class="table-responsive">
        <table class="table table-hover mb-0">
          <thead class="table-light">
            <tr>
              <th>Product</th>
              <th>Category</th>
              <th>Current Stock</th>
              <th>Threshold</th>
              <th>Selling Price</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for stock in page_obj %}
            <tr class="{% if stock.quantity == 0 %}out-of-stock-card{% elif stock.quantity <= 5 %}critical-card{% else %}alert-card{% endif %}">
              <td>
                <div class="fw-bold">{{ stock.product.name }}</div>
                <small class="text-muted">{{ stock.product.variation|default:"" }}</small>
              </td>
              <td>
                <span class="badge bg-light text-dark">{{ stock.product.category|default:"No Category" }}</span>
              </td>
              <td>
                <span class="fw-bold {% if stock.quantity == 0 %}text-danger{% elif stock.quantity <= 5 %}text-danger{% else %}text-warning{% endif %}">
                  {{ stock.quantity }}
                </span>
              </td>
              <td>{{ stock.low_stock_threshold }}</td>
              <td>ETB {{ stock.selling_price }}</td>
              <td>
                {% if stock.quantity == 0 %}
                  <span class="stock-status-badge status-out">Out of Stock</span>
                {% elif stock.quantity <= 5 %}
                  <span class="stock-status-badge status-critical">Critical</span>
                {% else %}
                  <span class="stock-status-badge status-low">Low Stock</span>
                {% endif %}
              </td>
              <td>
                <div class="d-flex gap-1">
                  <a href="{% url 'stock_detail' stock.id %}" class="btn btn-sm btn-ezm-primary">
                    <i class="bi bi-eye me-1"></i>Details
                  </a>
                  <button class="btn btn-sm btn-ezm-secondary" 
                          onclick="requestRestock({{ stock.product.id }}, '{{ stock.product.name|escapejs }}')">
                    <i class="bi bi-arrow-up-circle me-1"></i>Restock
                  </button>
                </div>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <!-- Pagination -->
      {% if page_obj.has_other_pages %}
      <div class="d-flex justify-content-center mt-4 mb-3">
        <nav aria-label="Stock alerts pagination">
          <ul class="pagination">
            {% if page_obj.has_previous %}
              <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}{% if category_filter %}&category={{ category_filter }}{% endif %}">Previous</a>
              </li>
            {% endif %}
            
            {% for num in page_obj.paginator.page_range %}
              {% if page_obj.number == num %}
                <li class="page-item active">
                  <span class="page-link">{{ num }}</span>
                </li>
              {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                <li class="page-item">
                  <a class="page-link" href="?page={{ num }}{% if search_query %}&search={{ search_query }}{% endif %}{% if category_filter %}&category={{ category_filter }}{% endif %}">{{ num }}</a>
                </li>
              {% endif %}
            {% endfor %}
            
            {% if page_obj.has_next %}
              <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}{% if category_filter %}&category={{ category_filter }}{% endif %}">Next</a>
              </li>
            {% endif %}
          </ul>
        </nav>
      </div>
      {% endif %}

      {% else %}
      <div class="text-center py-5">
        <i class="bi bi-check-circle text-success fs-1 mb-3"></i>
        <h4 class="text-success">All Stock Levels Good!</h4>
        <p class="text-muted">No products are currently below their stock thresholds.</p>
        <a href="{% url 'stock_list' %}" class="btn btn-ezm-primary">
          <i class="bi bi-boxes me-1"></i>View All Stock
        </a>
      </div>
      {% endif %}
    </div>
  </div>
</div>

<script>
function requestRestock(productId, productName) {
  if (confirm('Request restock for ' + productName + '?\n\nThis will redirect you to the restock request page.')) {
    // Create a form and submit it to the restock request endpoint
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = '{% url "submit_restock_request" %}';
    
    // Add CSRF token
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
    if (csrfToken) {
      const csrfInput = document.createElement('input');
      csrfInput.type = 'hidden';
      csrfInput.name = 'csrfmiddlewaretoken';
      csrfInput.value = csrfToken.value;
      form.appendChild(csrfInput);
    }
    
    // Add product ID
    const productInput = document.createElement('input');
    productInput.type = 'hidden';
    productInput.name = 'product_id';
    productInput.value = productId;
    form.appendChild(productInput);
    
    // Add default values
    const quantityInput = document.createElement('input');
    quantityInput.type = 'hidden';
    quantityInput.name = 'quantity';
    quantityInput.value = '50'; // Default quantity
    form.appendChild(quantityInput);
    
    const priorityInput = document.createElement('input');
    priorityInput.type = 'hidden';
    priorityInput.name = 'priority';
    priorityInput.value = 'medium';
    form.appendChild(priorityInput);
    
    const notesInput = document.createElement('input');
    notesInput.type = 'hidden';
    notesInput.name = 'notes';
    notesInput.value = 'Quick restock request from stock alerts dashboard';
    form.appendChild(notesInput);
    
    document.body.appendChild(form);
    form.submit();
  }
}
</script>
{% endblock %}
